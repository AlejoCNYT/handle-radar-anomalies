<!DOCTYPE html>
<html>
<head>
    <title>Radar Dashboard</title>
    <style>
        body { background:#0d1117;color:white;font-family:Arial;margin:20px; }
        h1,h2 { color:#00e676; }
        .grid { display:grid; grid-template-columns:1fr 1fr; gap:30px; }
        .card { background:#161b22;padding:20px;border-radius:10px; }
        canvas { width:100%;height:250px; }
    </style>

    <!-- Librer√≠a para gr√°ficas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h1>üìä Radar de Latencia & Alertas</h1>

<div class="grid">
    <div class="card">
        <h2>P95 Latency (√∫ltimos 5m)</h2>
        <canvas id="p95Chart"></canvas>
    </div>

    <div class="card">
        <h2>Errores por minuto</h2>
        <canvas id="errorChart"></canvas>
    </div>
</div>

<div class="card" style="margin-top:30px;">
    <h2>üö® Alertas activas</h2>
    <ul id="alertList"></ul>
</div>

<script>
// ====== CONFIG API ======
const PROM = "http://localhost:9090/api/v1/query";

// === Requests cada 5s ===
setInterval(loadData, 5000);
loadData();

// === L√ìGICA PRINCIPAL ===
async function loadData(){
    loadP95();
    loadErrors();
    loadAlerts();
}

// ===== GR√ÅFICO P95 =====
async function loadP95(){
    let q = `histogram_quantile(0.95,rate(http_latency_ms_bucket[5m]))`;
    let res = await fetch(PROM+"?query="+encodeURIComponent(q));
    let data = await res.json();

    let val = data.data.result[0]?.value[1] ?? 0;
    addData(p95Chart, val);
}

// ===== ERRORES =====
async function loadErrors(){
    let q = `rate(http_errors_total[5m])`;
    let res = await fetch(PROM+"?query="+encodeURIComponent(q));
    let data = await res.json();

    let val = data.data.result[0]?.value[1] ?? 0;
    addData(errorChart, val);
}

// ===== ALERTAS =====
async function loadAlerts(){
    let res = await fetch("http://localhost:8082/alerts");
    let alerts = await res.json();

    let list = document.getElementById("alertList");
    list.innerHTML = alerts.length===0
        ? "<li>No hay alertas üîµ</li>"
        : alerts.map(a => `<li>‚ö† ${a.metric} ‚Äî ${a.value}ms (${a.severity})</li>`).join('');
}

// ====== CHART JS ======
function createChart(id,label,color){
    let c = document.getElementById(id).getContext("2d");
    return new Chart(c,{
        type:"line",
        data:{ labels:[], datasets:[{label,color,borderColor:color,data:[]}] },
        options:{scales:{y:{beginAtZero:true}}}
    });
}
function addData(chart,val){
    chart.data.labels.push("");
    chart.data.datasets[0].data.push(val);
    if(chart.data.labels.length>20) chart.data.labels.shift();
    chart.update();
}

const p95Chart   = createChart("p95Chart","p95","rgb(0,200,100)");
const errorChart = createChart("errorChart","errores","rgb(255,50,50)");

</script>
</body>
</html>
